<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cans & Teens - Canteen Ordering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            overflow-x: hidden;
        }
        .gradient-text {
            background: linear-gradient(90deg, #ec4899, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Preloader Animation Styles */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111827; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
        #preloader.hidden { opacity: 0; visibility: hidden; }
        .food-icon-container { position: relative; width: 200px; height: 100px; margin-bottom: 2rem; }
        .food-icon { font-size: 2rem; opacity: 0; animation: floatUp 3s ease-in-out infinite; position: absolute; }
        .food-icon:nth-child(1) { left: 10%; animation-delay: 0s; }
        .food-icon:nth-child(2) { left: 30%; animation-delay: 0.5s; }
        .food-icon:nth-child(3) { left: 50%; animation-delay: 1s; }
        .food-icon:nth-child(4) { left: 70%; animation-delay: 1.5s; }
        .food-icon:nth-child(5) { left: 90%; animation-delay: 2s; }
        @keyframes floatUp { 0% { transform: translateY(50px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        #preloader-title { animation: fadeInTitle 2s ease-in-out; }
        @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        #enter-btn { margin-top: 3rem; background: linear-gradient(90deg, #ec4899, #8b5cf6); color: white; padding: 12px 24px; border-radius: 99px; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); transition: all 0.3s ease; animation: pulse 2s infinite; }
        #enter-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(139, 92, 246, 0.7); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        
        #app-container { visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in, visibility 0.5s ease-in; }
        #app-container.visible { visibility: visible; opacity: 1; }
        
        .form-input { background-color: #1f2937; border: 1px solid #374151; color: white; }
        
        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Aesthetically Pleasing Rotating Wheel */
        #wheel-section { display: flex; justify-content: center; align-items: center; padding-top: 1rem; padding-bottom: 2rem; margin-bottom: 1rem; min-height: 350px; }
        #wheel-container { position: relative; width: 320px; height: 320px; display: flex; justify-content: center; align-items: center; }
        #wheel { position: absolute; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); cursor: grab; }
        #wheel:active { cursor: grabbing; }
        #wheel-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid #374151; box-shadow: 0 0 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.3); }
        .wheel-item { position: absolute; top: 50%; left: 50%; transform-origin: center center; user-select: none; text-align: center; cursor: pointer; }
        .wheel-item-pod { width: 90px; height: 90px; background-color: #1f2937; border: 2px solid #4b5563; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 600; color: #9ca3af; box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: all 0.4s ease; }
        .wheel-item.active .wheel-item-pod { background-color: #ec4899; border-color: #fbcfe8; color: white; transform: scale(1.15); box-shadow: 0 0 20px #ec4899; }
        #wheel-center { width: 140px; height: 140px; background-color: #111827; border: 4px solid #374151; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-align: center; font-weight: 800; font-size: 1.25rem; padding: 1rem; z-index: 10; }
        #wheel-pointer { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 18px solid #ec4899; z-index: 20; }
    
        /* Fly to cart animation */
        .fly-to-cart {
            position: fixed;
            z-index: 100;
            border-radius: 10%;
            transition: all 0.5s cubic-bezier(0.5, 0, 1, 0.5);
        }
        
        /* Loading skeleton styles */
        .skeleton-card { background-color: #1f2937; border-radius: 0.75rem; overflow: hidden; animation: pulse-bg 1.5s infinite; }
        .skeleton-img { height: 12rem; background-color: #374151; }
        .skeleton-text-lg { height: 1.25rem; width: 75%; margin-top: 1rem; background-color: #374151; border-radius: 0.25rem; }
        .skeleton-text-sm { height: 0.875rem; width: 50%; margin-top: 0.5rem; background-color: #374151; border-radius: 0.25rem; }
        @keyframes pulse-bg { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="antialiased">

    <div id="preloader">
        <div class="food-icon-container">
            <span class="food-icon">üçî</span><span class="food-icon">üçï</span><span class="food-icon">üçú</span><span class="food-icon">üç©</span><span class="food-icon">ü•™</span>
        </div>
        <h1 id="preloader-title" class="text-4xl md:text-5xl font-extrabold gradient-text">Cans & Teens</h1>
        <button id="enter-btn">Click to Enter</button>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6"></div>
    
    <!-- Firebase Imports -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Link to your configuration file -->
    <script src="firebase-config.js"></script>
    <!-- Verification client (student sign-in) -->
    <script src="verification.js"></script>

    <script>
        // --- DATA (This will soon be replaced by Firebase) ---
        let menu = [
            { id: 1, name: 'Pav Bhaji', category: 'Main Course', price: 80, image: 'https://i.pinimg.com/1200x/9f/61/b5/9f61b5dff080cc8f1795ecb8c326a363.jpg' },
            { id: 2, name: 'Chole Bhature', category: 'Main Course', price: 90, image: 'https://i.pinimg.com/736x/d6/60/25/d660255e0ac13e20bc3c674ee3d11ac4.jpg' },
            { id: 3, name: 'Thali', category: 'Main Course', price: 120, image: 'https://i.pinimg.com/736x/bc/54/5c/bc545c4796c7665529d55eae56116ceb.jpg' },
            { id: 4, name: 'Samosa', category: 'Snacks', price: 15, image: 'https://i.pinimg.com/1200x/1b/da/ca/1bdaca54b40441bc8a1bccc733e3ca43.jpg' },
            { id: 5, name: 'Pasta', category: 'Continental', price: 100, image: 'https://i.pinimg.com/736x/e8/68/c8/e868c8f4d0928bcb470fcf4e69c212cc.jpg' },
            { id: 6, name: 'Chilli Potato', category: 'Chinese', price: 70, image: 'https://i.pinimg.com/736x/48/9a/bb/489abb29b2d64369cf19d5109b39a918.jpg' },
            { id: 7, name: 'Dosa', category: 'South Indian', price: 60, image: 'https://i.pinimg.com/736x/bc/c2/73/bcc273590ad49ae3e93e7ef66773cb40.jpg' },
            { id: 8, name: 'Idli', category: 'South Indian', price: 50, image: 'https://i.pinimg.com/736x/31/17/79/3117798277633d30993e40fdb344e789.jpg' },
            { id: 9, name: 'Gulab Jamun', category: 'Desserts', price: 30, image: 'https://i.pinimg.com/1200x/dc/1d/d6/dc1dd615ac36b0a37223a3678aaa7668.jpg' },
            { id: 10, name: 'Jalebi', category: 'Desserts', price: 40, image: 'https://i.pinimg.com/736x/21/ca/d2/21cad2816230d87001208d8b48ec49d2.jpg' },
            { id: 11, name: 'Burger', category: 'Continental', price: 50, image: 'https://i.pinimg.com/1200x/11/c4/1b/11c41bee8a8ade2a3513ad8f02d0aee2.jpg' },
            { id: 12, name: 'Sandwich', category: 'Snacks', price: 40, image: 'https://i.pinimg.com/736x/16/c6/e9/16c6e980c05d7be810c168f1ed5b0534.jpg' },
            { id: 13, name: 'Chowmein', category: 'Chinese', price: 65, image: 'https://i.pinimg.com/736x/37/77/a3/3777a38c1565dffd66800f39681007f7.jpg' },
            { id: 14, name: 'Momos', category: 'Chinese', price: 60, image: 'https://i.pinimg.com/1200x/04/6e/ee/046eeed79cb69133d373eec345517561.jpg' },
            { id: 15, name: 'French Fries', category: 'Snacks', price: 50, image: 'https://i.pinimg.com/1200x/99/9b/fc/999bfc3c4672ce0553a9ca4c7fe1a87c.jpg' },
            { id: 16, name: 'Maggi', category: 'Snacks', price: 40, image: 'https://i.pinimg.com/736x/30/f6/a4/30f6a4357a7d192e939874a4b8c43e62.jpg' },
            { id: 17, name: 'Spring Rolls', category: 'Chinese', price: 55, image: 'https://i.pinimg.com/1200x/6e/30/c0/6e30c0ce304c63b176e454c72fe8b807.jpg' },
            { id: 18, name: 'Kathi Roll', category: 'Main Course', price: 90, image: 'https://i.pinimg.com/736x/60/7e/b2/607eb272e2c7806bb4803625d04ea607.jpg' },
            { id: 19, name: 'Cold Coffee', category: 'Beverages', price: 60, image: 'https://i.pinimg.com/736x/fd/a9/ad/fda9ad56b9d62070fec105cd93693129.jpg' },
            { id: 20, name: 'Fresh Juice', category: 'Beverages', price: 50, image: 'https://i.pinimg.com/736x/3a/4f/9d/3a4f9dbce23756aea5bd692b07f26c71.jpg' },
        ];
        let categories = ['All', ...[...new Set(menu.map(item => item.category))].sort()];

        const state = {
            currentScreen: 'menu', cart: [],
            filters: { category: 'All', maxPrice: 150, searchTerm: '' },
            wheel: { angle: 0, startAngle: 0, isDragging: false },
            audioReady: false,
        };

        // --- RENDER & EVENT HANDLER FUNCTIONS (abbreviated for clarity) ---
        function render() { const app = document.getElementById('app-container'); if(!app) return; app.innerHTML = ''; switch(state.currentScreen) { case 'menu': app.innerHTML = renderMenuScreen(); break; case 'cart': app.innerHTML = renderCartScreen(); break; case 'confirmation': app.innerHTML = renderConfirmationScreen(); break; default: app.innerHTML = renderMenuScreen(); } attachEventListeners(); if (state.currentScreen === 'menu') setupWheel(); }
        function renderMenuScreen(showSkeletons = false) { const menuGrid = document.getElementById('menu-grid'); if (showSkeletons && menuGrid) { menuGrid.innerHTML = Array(8).fill('').map(renderSkeletonCard).join(''); return; } const filteredMenu = menu.filter(item => (state.filters.category === 'All' || item.category === state.filters.category) && item.price <= state.filters.maxPrice && item.name.toLowerCase().includes(state.filters.searchTerm.toLowerCase()) ); if (!menuGrid) { return ` <div id="menu-screen" class="fade-in"> <header class="flex justify-between items-center mb-4"> <h1 class="text-3xl font-extrabold gradient-text">Cans & Teens</h1> <button id="cart-nav-btn" class="relative bg-violet-600 p-3 rounded-full hover:bg-violet-700 transition"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg> ${state.cart.length > 0 ? `<span id="cart-count" class="absolute -top-1 -right-1 bg-pink-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">${state.cart.reduce((a, c) => a + c.quantity, 0)}</span>` : '<span id="cart-count"></span>'} </button> </header> <div class="bg-gray-800 p-4 rounded-xl mb-6"> <div id="wheel-section"> <div id="wheel-container"> <div id="wheel-pointer"></div> <div id="wheel-ring"></div> <div id="wheel" style="transform: rotate(${state.wheel.angle}deg);"></div> <div id="wheel-center"><span class="gradient-text">Cans &<br/>Teens</span></div> </div> </div> <div class="relative mb-4 px-4"> <input type="text" id="search-bar" placeholder="Search for a dish..." class="w-full form-input rounded-full py-3 px-5" value="${state.filters.searchTerm}"> </div> <div class="px-4"> <label for="price-slider" class="block text-sm text-gray-400 mb-2 text-center">Filter by Price (under ‚Çπ${state.filters.maxPrice})</label> <input type="range" id="price-slider" min="10" max="150" value="${state.filters.maxPrice}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"> </div> </div> <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"> ${filteredMenu.length > 0 ? filteredMenu.map(renderMenuItem).join('') : '<p class="col-span-full text-center text-gray-400">No dishes match your filters.</p>'} </div> </div> `; } menuGrid.innerHTML = filteredMenu.length > 0 ? filteredMenu.map(renderMenuItem).join('') : '<p class="col-span-full text-center text-gray-400">No dishes match your filters.</p>'; document.querySelectorAll('.add-to-cart-btn').forEach(b => b.addEventListener('click', handleAddToCart)); }
        function renderMenuItem(item) { return ` <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg flex flex-col transform hover:-translate-y-1 transition-transform duration-300"> <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover card-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1f2937/fff?text=Image+Error';"> <div class="p-4 flex flex-col flex-grow"> <h3 class="text-lg font-bold text-white leading-tight">${item.name}</h3> <p class="text-sm text-gray-400 mt-1 font-medium">${item.category}</p> <div class="flex-grow"></div> <div class="flex justify-between items-center mt-4"> <span class="text-xl font-extrabold text-white">‚Çπ${item.price}</span> <button class="add-to-cart-btn bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition" data-id="${item.id}">Add</button> </div> </div> </div>`; }
        function renderSkeletonCard() { return ` <div class="skeleton-card"> <div class="skeleton-img"></div> <div class="p-4"> <div class="skeleton-text-lg"></div> <div class="skeleton-text-sm"></div> </div> </div> `; }
        function renderCartScreen() { if (state.cart.length === 0) { return `<div id="cart-screen" class="text-center fade-in"><h1 class="text-3xl font-extrabold gradient-text mb-4">Your Cart is Empty</h1><button class="back-to-menu-btn bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-6 rounded-lg transition">Browse Menu</button></div>`; } const total = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0); return `<div id="cart-screen" class="fade-in max-w-2xl mx-auto"><header class="flex items-center mb-6"><button class="back-to-menu-btn p-2 rounded-full hover:bg-gray-700 mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button><h1 class="text-3xl font-extrabold gradient-text">Your Order</h1></header><div class="space-y-4 bg-gray-800 p-6 rounded-xl">${state.cart.map(item => `<div class="flex justify-between items-center"><div><p class="font-semibold text-lg">${item.name}</p><p class="text-sm text-gray-400">‚Çπ${item.price}</p></div><div class="flex items-center gap-4"><button class="quantity-btn bg-gray-700 p-1 rounded-full" data-id="${item.id}" data-change="-1">-</button><span>${item.quantity}</span><button class="quantity-btn bg-gray-700 p-1 rounded-full" data-id="${item.id}" data-change="1">+</button></div></div>`).join('')}<div class="border-t border-gray-700 pt-4 mt-4 text-xl font-bold flex justify-between"><span>Total (No Taxes)</span><span>‚Çπ${total}</span></div></div><div class="mt-6 bg-gray-800 p-6 rounded-xl"><h2 class="text-xl font-bold text-center mb-4">Feeling Adventurous?</h2><button id="suggestion-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition">‚ú® Suggest a Combo</button><div id="suggestion-result"></div></div><div class="mt-6"><button id="checkout-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-extrabold text-lg py-4 px-4 rounded-lg transition">Proceed to Payment</button></div></div>`;}
        function renderConfirmationScreen() { return `<div id="confirmation-screen" class="text-center fade-in max-w-md mx-auto bg-gray-800 p-8 rounded-2xl"><div class="text-6xl mb-4">‚úÖ</div><h1 class="text-3xl font-extrabold gradient-text mb-2">Payment Confirmed!</h1><p class="text-gray-400 mb-6">Your order is being prepared. You and the canteen have received a confirmation. Enjoy your meal!</p><button class="back-to-menu-btn bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition">Order Again</button></div>`;}
        function attachEventListeners() { document.querySelectorAll('.add-to-cart-btn').forEach(b => b.addEventListener('click', handleAddToCart)); document.querySelector('#cart-nav-btn')?.addEventListener('click', () => navigateTo('cart')); document.querySelectorAll('.quantity-btn').forEach(b => b.addEventListener('click', handleQuantityChange)); document.querySelector('#checkout-btn')?.addEventListener('click', handleCheckout); document.querySelectorAll('.back-to-menu-btn').forEach(b => b.addEventListener('click', () => navigateTo('menu'))); document.querySelector('#suggestion-btn')?.addEventListener('click', () => getMealSuggestion(state.cart.map(i => i.name))); document.querySelector('#search-bar')?.addEventListener('input', handleFilterChange); document.querySelector('#price-slider')?.addEventListener('input', handleFilterChange); }
        function handleFilterChange() { state.filters.searchTerm = document.getElementById('search-bar').value; state.filters.maxPrice = parseInt(document.getElementById('price-slider').value); renderMenuScreen(true); setTimeout(() => renderMenuScreen(false), 200); }
        function handleAddToCart(e) { const button = e.target; const card = button.closest('.bg-gray-800'); const imageEl = card.querySelector('.card-image'); const cartIcon = document.getElementById('cart-nav-btn'); if (imageEl && cartIcon) { const rect = imageEl.getBoundingClientRect(); const flyingImage = imageEl.cloneNode(); flyingImage.classList.add('fly-to-cart'); flyingImage.style.left = `${rect.left}px`; flyingImage.style.top = `${rect.top}px`; flyingImage.style.width = `${rect.width}px`; flyingImage.style.height = `${rect.height}px`; document.body.appendChild(flyingImage); const cartRect = cartIcon.getBoundingClientRect(); requestAnimationFrame(() => { flyingImage.style.left = `${cartRect.left + cartRect.width / 2}px`; flyingImage.style.top = `${cartRect.top + cartRect.height / 2}px`; flyingImage.style.width = '0px'; flyingImage.style.height = '0px'; flyingImage.style.opacity = '0.5'; }); setTimeout(() => flyingImage.remove(), 500); } const originalText = button.innerHTML; button.innerHTML = '‚úì'; button.disabled = true; setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 1000); const id = parseInt(button.dataset.id); const i = state.cart.find(item => item.id === id); if(i) i.quantity++; else { const item = menu.find(m => m.id === id); state.cart.push({...item, quantity: 1}); } const cartCountEl = document.getElementById('cart-count'); if(cartCountEl) { const total = state.cart.reduce((a, c) => a + c.quantity, 0); if (total > 0) { cartCountEl.innerText = total; cartCountEl.className = 'absolute -top-1 -right-1 bg-pink-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center'; } else { cartCountEl.innerHTML = ''; } } }
        function handleQuantityChange(e) { const id = parseInt(e.target.dataset.id); const c = parseInt(e.target.dataset.change); const i = state.cart.find(item => item.id === id); if (i) { i.quantity += c; if (i.quantity <= 0) state.cart = state.cart.filter(item => item.id !== id); } render(); }
        function handleCheckout() { navigateTo('confirmation'); state.cart = []; }
        function navigateTo(screen) { state.currentScreen = screen; render(); }
        function setupWheel() { const wheel = document.getElementById('wheel'); if (!wheel) return; wheel.innerHTML = ''; const radius = 115; const angleStep = 360 / categories.length; categories.forEach((cat, index) => { const item = document.createElement('div'); item.className = 'wheel-item'; const angle = index * angleStep; const x = radius * Math.sin(angle * Math.PI / 180); const y = -radius * Math.cos(angle * Math.PI / 180); item.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`; const pod = document.createElement('div'); pod.className = 'wheel-item-pod'; pod.textContent = cat; item.appendChild(pod); item.addEventListener('click', () => handlePodClick(index)); wheel.appendChild(item); }); updateActiveWheelItem(); wheel.addEventListener('mousedown', handleDragStart); wheel.addEventListener('touchstart', handleDragStart, { passive: false }); }
        function handlePodClick(index) { if (state.wheel.isDragging) return; const angleStep = 360 / categories.length; let targetAngle = - (index * angleStep); const currentAngle = state.wheel.angle; const diff = targetAngle - currentAngle; if (Math.abs(diff) > 180) { targetAngle += diff > 0 ? -360 : 360; } state.wheel.angle = targetAngle; wheelFilterRender(); }
        function getAngle(x, y) { return Math.atan2(y, x) * 180 / Math.PI; }
        function handleDragStart(e) { e.preventDefault(); state.wheel.isDragging = true; const wheel = document.getElementById('wheel'); const rect = wheel.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const startAngle = getAngle(clientX - centerX, clientY - centerY); state.wheel.startAngle = startAngle - state.wheel.angle; window.addEventListener('mousemove', handleDragMove); window.addEventListener('touchmove', handleDragMove, { passive: false }); window.addEventListener('mouseup', handleDragEnd); window.addEventListener('touchend', handleDragEnd); }
        function handleDragMove(e) { if (!state.wheel.isDragging) return; e.preventDefault(); const wheel = document.getElementById('wheel'); const rect = wheel.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const currentAngle = getAngle(clientX - centerX, clientY - centerY); state.wheel.angle = currentAngle - state.wheel.startAngle; wheel.style.transition = 'none'; wheel.style.transform = `rotate(${state.wheel.angle}deg)`; }
        function handleDragEnd() { if (!state.wheel.isDragging) return; state.wheel.isDragging = false; const wheel = document.getElementById('wheel'); if (wheel) wheel.style.transition = 'transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55)'; const angleStep = 360 / categories.length; const closestIndex = Math.round(state.wheel.angle / angleStep); state.wheel.angle = closestIndex * angleStep; wheelFilterRender(); }
        function wheelFilterRender() { document.getElementById('wheel').style.transform = `rotate(${state.wheel.angle}deg)`; updateActiveWheelItem(); }
        function updateActiveWheelItem() { const angleStep = 360 / categories.length; let currentAngle = (state.wheel.angle % 360 + 360) % 360; const activeIndex = Math.round((360 - currentAngle) / angleStep) % categories.length; document.querySelectorAll('.wheel-item').forEach((item, index) => { item.classList.toggle('active', index === activeIndex); }); if (state.filters.category !== categories[activeIndex]) { state.filters.category = categories[activeIndex]; handleFilterChange(); } }
        function playFanfareSound() { if (state.audioReady) { const synth = new Tone.MonoSynth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.2, release: 0.9 }, filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.8, baseFrequency: 300, octaves: 4 } }).toDestination(); const now = Tone.now(); synth.triggerAttackRelease('C5', '8n', now); synth.triggerAttackRelease('G5', '8n', now + 0.2); synth.triggerAttackRelease('C6', '4n', now + 0.4); } }
        function autoSpinWheel() { const wheel = document.getElementById('wheel'); if (!wheel) return; const allCategoryIndex = categories.findIndex(c => c === 'All'); if (allCategoryIndex === -1) return; const angleStep = 360 / categories.length; const finalAngle = -(allCategoryIndex * angleStep); const spinAngle = finalAngle + 360 * 3; const onSpinEnd = () => { playFanfareSound(); state.wheel.angle = finalAngle; }; wheel.addEventListener('transitionend', onSpinEnd, { once: true }); wheel.style.transition = 'transform 2.5s cubic-bezier(0.25, 1, 0.5, 1)'; wheel.style.transform = `rotate(${spinAngle}deg)`; setTimeout(() => { if(wheel) wheel.style.transition = 'transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55)'; }, 2500); }
        function handleEnter() { if (!state.audioReady) { Tone.start(); state.audioReady = true; } hidePreloader(); setTimeout(autoSpinWheel, 100); }
        function hidePreloader() { const preloader = document.getElementById('preloader'); const appContainer = document.getElementById('app-container'); if (preloader && !preloader.classList.contains('hidden')) { preloader.classList.add('hidden'); appContainer.classList.add('visible'); } }
        function setupPreloader() { document.getElementById('enter-btn')?.addEventListener('click', handleEnter, { once: true }); }
        async function getMealSuggestion(cartItems) { const sBtn=document.getElementById('suggestion-btn'), sRes=document.getElementById('suggestion-result'); if(!sBtn||!sRes)return; sBtn.disabled=true;sBtn.innerHTML=`<span class="loader"></span><span class="ml-2">Thinking...</span>`; sRes.innerHTML=''; const sys="You are a fun, friendly college canteen assistant with a GenZ vibe. Your goal is to suggest ONE extra food item that would be a great combo with the user's current order. Keep it short, exciting, and to the point. Start with a cool phrase. Don't use emojis."; const user=`My current order is: ${cartItems.join(', ')}. What's ONE more thing from the menu that would be an epic combo with this? Full menu: ${menu.map(i=>i.name).join(', ')}.`; try { const apiKey=""; const apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload={contents:[{parts:[{text:user}]}],systemInstruction:{parts:[{text:sys}]}}; const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!response.ok){throw new Error(`API Error: ${response.statusText}`);} const result=await response.json(); const text=result.candidates?.[0]?.content?.parts?.[0]?.text; if(text){sRes.innerHTML=`<p class="mt-4 text-center text-teal-300 p-3 bg-gray-700/50 rounded-lg">${text}</p>`;}else{throw new Error("No suggestion.");}}catch(error){console.error("Gemini API call failed:",error);sRes.innerHTML=`<p class="mt-4 text-center text-red-400">Couldn't get a suggestion. Try again!`;}finally{sBtn.disabled=false;sBtn.innerHTML='‚ú® Suggest a Combo';} }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // We'll add Firebase init logic here
                setupPreloader();
                render();
            } catch (error) {
                console.error("Critical error on startup:", error);
                hidePreloader();
                const app = document.getElementById('app-container');
                if (app) app.innerHTML = `<div class="text-center text-red-400 p-8 bg-gray-800 rounded-lg"><h1 class="text-2xl font-bold mb-2">Oops! Something went wrong.</h1><p>The application could not be loaded. Please try refreshing the page.</p></div>`;
            }
        });
    </script>
</body>
</html>
